blueprint:
  name: Universal Critical Monitor
  description: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —á–∏—Å–ª–æ–≤—ã—Ö –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
  domain: automation

input:
  telegram_chat_id:
    name: Telegram Chat ID
    description: ID —á–∞—Ç–∞ –∏–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
    selector:
      text:
  entities_config:
    name: Entities Configuration
    description: –°–ø–∏—Å–æ–∫ —Å—É—â–Ω–æ—Å—Ç–µ–π –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YAML
    selector:
      object:

variables:
  telegram_chat_id: !input telegram_chat_id
  entities_config: !input entities_config

trigger:
  - platform: state
    entity_id: >
      {% set entities = [] %}
      {% for item in entities_config %}
        {% set _ = entities.append(item.entity_id) %}
      {% endfor %}
      {{ entities }}

action:
  - variables:
      entity_id: "{{ trigger.entity_id }}"
      new_state: "{{ trigger.to_state.state }}"
      old_state: "{{ trigger.from_state.state }}"
      
      config: >-
        {% for item in entities_config %}
          {% if item.entity_id == entity_id %}
            {{ item }}
          {% endif %}
        {% endfor %}
      
      # –£–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è
      check_result: >-
        {% set c = config %}
        {% set value = new_state %}
        {% set is_numeric = value is number or value | float != 0.0 or value == '0' %}
        {% set num_value = value | float(default=0) %}
        
        {% set trigger_alert = false %}
        {% set alert_reason = "" %}
        
        {% if is_numeric %}
          # –ß–∏—Å–ª–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
          {% if c.check_above is defined and num_value > c.check_above %}
            {% set trigger_alert = true %}
            {% set alert_reason = "above" %}
          {% elif c.check_below is defined and num_value < c.check_below %}
            {% set trigger_alert = true %}
            {% set alert_reason = "below" %}
          {% endif %}
        {% else %}
          # –¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
          {% if c.check_state is defined and value == c.check_state %}
            {% set trigger_alert = true %}
            {% set alert_reason = "state_match" %}
          {% elif c.check_states is defined and value in c.check_states %}
            {% set trigger_alert = true %}
            {% set alert_reason = "state_in_list" %}
          {% endif %}
        {% endif %}
        
        {{ {
          "alert": trigger_alert,
          "reason": alert_reason,
          "is_numeric": is_numeric,
          "numeric_value": num_value
        } }

  - if:
      - condition: template
        value_template: "{{ check_result.alert }}"
    then:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ check_result.reason == 'above' }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  target: "{{ telegram_chat_id }}"
                  message: >-
                    üö® *–ü–†–ï–í–´–®–ï–ù–ò–ï - {{ config.name | default(entity_id) }}*
                    
                    üìä *–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:* {{ new_state }}{{ config.unit | default('') }}
                    üìà *–ü—Ä–µ–≤—ã—à–µ–Ω –ø–æ—Ä–æ–≥:* {{ config.check_above }}{{ config.unit | default('') }}
                    ‚ö†Ô∏è *–°—Ç–∞—Ç—É—Å:* –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
                    
                    üí° *–î–µ–π—Å—Ç–≤–∏–µ:* {{ config.action | default('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ') }}
                  parse_mode: markdown
          
          - conditions:
              - condition: template
                value_template: "{{ check_result.reason == 'below' }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  target: "{{ telegram_chat_id }}"
                  message: >-
                    üö® *–ù–ò–ñ–ï –ù–û–†–ú–´ - {{ config.name | default(entity_id) }}*
                    
                    üìä *–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:* {{ new_state }}{{ config.unit | default('') }}
                    üìâ *–ù–∏–∂–µ –ø–æ—Ä–æ–≥–∞:* {{ config.check_below }}{{ config.unit | default('') }}
                    ‚ö†Ô∏è *–°—Ç–∞—Ç—É—Å:* –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
                    
                    üí° *–î–µ–π—Å—Ç–≤–∏–µ:* {{ config.action | default('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ') }}
                  parse_mode: markdown

mode: single
