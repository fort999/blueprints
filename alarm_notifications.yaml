blueprint:
  name: Universal Critical Values Monitor (notify.send_message)
  description: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –ø–µ—Ä–µ–¥ —Ç—Ä–µ–≤–æ–≥–æ–π. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —á–∏—Å–ª–æ–≤—ã–µ –ø–æ—Ä–æ–≥–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏–π.
  domain: automation

  input:
    entities_config:
      name: Entities Configuration
      description: >
        –ü—Ä–∏–º–µ—Ä:
        - entity_id: sensor.temp
          name: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
          unit: ¬∞C
          check_above: 30
          check_below: 15
          action: –í–∫–ª—é—á–∏—Ç—å –æ—Ö–ª–∞–∂–¥–µ–Ω–∏–µ
      selector:
        object:

    delay_seconds:
      name: Delay before alert (sec)
      default: 15
      selector:
        number:
          min: 1
          max: 300
          unit_of_measurement: sec

trigger:
  - platform: state

variables:
  entities_config: !input entities_config
  delay_seconds: !input delay_seconds
  monitored_entities: >
    {{ entities_config | map(attribute='entity_id') | list }}

condition:
  - condition: template
    value_template: "{{ trigger.entity_id in monitored_entities }}"

action:

  - delay:
      seconds: "{{ delay_seconds }}"

  - variables:
      entity_id: "{{ trigger.entity_id }}"
      state_now: "{{ states(entity_id) }}"

      entity_config: >
        {% for item in entities_config %}
          {% if item.entity_id == entity_id %}
            {{ item }}
          {% endif %}
        {% endfor %}

      check_result: >
        {% set c = entity_config %}
        {% if c is none %}
          {{ {'alert': false} }}
        {% else %}
          {% set value = state_now %}
          {% set num_value = value | float(default=none) %}
          {% set is_numeric = num_value is not none %}

          {% set alert = false %}
          {% set reason = '' %}
          {% set threshold = 0 %}

          {% if is_numeric %}
            {% if c.check_above is defined and num_value > c.check_above %}
              {% set alert = true %}
              {% set reason = 'above' %}
              {% set threshold = c.check_above %}
            {% elif c.check_below is defined and num_value < c.check_below %}
              {% set alert = true %}
              {% set reason = 'below' %}
              {% set threshold = c.check_below %}
            {% endif %}
          {% else %}
            {% if c.check_state is defined and value == c.check_state %}
              {% set alert = true %}
              {% set reason = 'state_match' %}
            {% elif c.check_states is defined and value in c.check_states %}
              {% set alert = true %}
              {% set reason = 'state_in_list' %}
            {% endif %}
          {% endif %}

          {{ {'alert': alert, 'reason': reason, 'threshold': threshold} }}
        {% endif %}

  - condition: template
    value_template: "{{ check_result.alert }}"

  - choose:

      - conditions:
          - condition: template
            value_template: "{{ check_result.reason == 'above' }}"
        sequence:
          - action: notify.send_message
            target:
              entity_id: notify.alarm
            data:
              message: >
                üö® *–ü–†–ï–í–´–®–ï–ù–ò–ï - {{ entity_config.name | default(entity_id) }}*
                üìä –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: **{{ state_now }}{{ entity_config.unit | default('') }}**
                üìà –ü–æ—Ä–æ–≥: **{{ check_result.threshold }}{{ entity_config.unit | default('') }}**
                ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
                üí° –î–µ–π—Å—Ç–≤–∏–µ: {{ entity_config.action | default('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ') }}

      - conditions:
          - condition: template
            value_template: "{{ check_result.reason == 'below' }}"
        sequence:
          - action: notify.send_message
            target:
              entity_id: notify.alarm
            data:
              message: >
                üö® *–ù–ò–ñ–ï –ù–û–†–ú–´ - {{ entity_config.name | default(entity_id) }}*
                üìä –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: **{{ state_now }}{{ entity_config.unit | default('') }}**
                üìâ –ü–æ—Ä–æ–≥: **{{ check_result.threshold }}{{ entity_config.unit | default('') }}**
                ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
                üí° –î–µ–π—Å—Ç–≤–∏–µ: {{ entity_config.action | default('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ') }}

      - conditions:
          - condition: template
            value_template: "{{ check_result.reason in ['state_match', 'state_in_list'] }}"
        sequence:
          - action: notify.send_message
            target:
              entity_id: notify.alarm
            data:
              message: >
                üö® *–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –°–û–°–¢–û–Ø–ù–ò–ï - {{ entity_config.name | default(entity_id) }}*
                üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: **{{ state_now }}**
                ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è
                üí° –î–µ–π—Å—Ç–≤–∏–µ: {{ entity_config.action | default('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞') }}

mode: single
