blueprint:
  name: Universal Critical Values Monitor
  description: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
  domain: automation
  input:
    telegram_chat_id:
      name: Telegram Chat ID
      description: ID —á–∞—Ç–∞ –∏–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
      selector:
        text:
    entities_config:
      name: Entities Configuration
      description: –°–ø–∏—Å–æ–∫ —Å—É—â–Ω–æ—Å—Ç–µ–π –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YAML
      selector:
        object:

trigger:
  - platform: state
    entity_id: >
      {% set entities = [] %}
      {% for item in inputs.entities_config %}
        {% set _ = entities.append(item.entity_id) %}
      {% endfor %}
      {{ entities }}

variables:
  telegram_chat_id: !input telegram_chat_id
  entities_config: !input entities_config

action:
  - variables:
      entity_id: "{{ trigger.entity_id }}"
      new_state: "{{ trigger.to_state.state }}"
      old_state: "{{ trigger.from_state.state }}"
      
      # –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—É—â–Ω–æ—Å—Ç–∏
      entity_config: >
        {% set config = None %}
        {% for item in entities_config %}
          {% if item.entity_id == entity_id %}
            {% set config = item %}
          {% endif %}
        {% endfor %}
        {{ config }}
      
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      check_result: >
        {% set c = entity_config %}
        {% if c is none %}
          {{ {'alert': false, 'reason': 'no_config'} }}
        {% else %}
          {% set value = new_state %}
          {% set num_value = value | float(default=none) %}
          {% set is_numeric = num_value is not none %}
          
          {% set alert = false %}
          {% set reason = '' %}
          {% set threshold = 0 %}
          
          {% if is_numeric %}
            {% if c.check_above is defined and num_value > c.check_above %}
              {% set alert = true %}
              {% set reason = 'above' %}
              {% set threshold = c.check_above %}
            {% elif c.check_below is defined and num_value < c.check_below %}
              {% set alert = true %}
              {% set reason = 'below' %}
              {% set threshold = c.check_below %}
            {% endif %}
          {% else %}
            {% if c.check_state is defined and value == c.check_state %}
              {% set alert = true %}
              {% set reason = 'state_match' %}
            {% elif c.check_states is defined and value in c.check_states %}
              {% set alert = true %}
              {% set reason = 'state_in_list' %}
            {% endif %}
          {% endif %}
          
          {{ {'alert': alert, 'reason': reason, 'threshold': threshold, 'is_numeric': is_numeric} }}
        {% endif %}

  - if:
      - condition: template
        value_template: "{{ check_result.alert }}"
    then:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ check_result.reason == 'above' }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  target: "{{ telegram_chat_id }}"
                  message: >
                    üö® *–ü–†–ï–í–´–®–ï–ù–ò–ï - {{ entity_config.name | default(entity_id) }}*
                    
                    üìä *–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:* {{ new_state }}{{ entity_config.unit | default('') }}
                    üìà *–ü—Ä–µ–≤—ã—à–µ–Ω –ø–æ—Ä–æ–≥:* {{ check_result.threshold }}{{ entity_config.unit | default('') }}
                    ‚ö†Ô∏è *–°—Ç–∞—Ç—É—Å:* –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
                    
                    üí° *–î–µ–π—Å—Ç–≤–∏–µ:* {{ entity_config.action | default('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ') }}
                  parse_mode: markdown
          
          - conditions:
              - condition: template
                value_template: "{{ check_result.reason == 'below' }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  target: "{{ telegram_chat_id }}"
                  message: >
                    üö® *–ù–ò–ñ–ï –ù–û–†–ú–´ - {{ entity_config.name | default(entity_id) }}*
                    
                    üìä *–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:* {{ new_state }}{{ entity_config.unit | default('') }}
                    üìâ *–ù–∏–∂–µ –ø–æ—Ä–æ–≥–∞:* {{ check_result.threshold }}{{ entity_config.unit | default('') }}
                    ‚ö†Ô∏è *–°—Ç–∞—Ç—É—Å:* –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
                    
                    üí° *–î–µ–π—Å—Ç–≤–∏–µ:* {{ entity_config.action | default('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ') }}
                  parse_mode: markdown
          
          - conditions:
              - condition: template
                value_template: "{{ check_result.reason in ['state_match', 'state_in_list'] }}"
            sequence:
              - service: telegram_bot.send_message
                data:
                  target: "{{ telegram_chat_id }}"
                  message: >
                    üö® *–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –°–û–°–¢–û–Ø–ù–ò–ï - {{ entity_config.name | default(entity_id) }}*
                    
                    üìä *–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:* {{ new_state }}
                    ‚ö†Ô∏è *–°—Ç–∞—Ç—É—Å:* –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è
                    
                    üí° *–î–µ–π—Å—Ç–≤–∏–µ:* {{ entity_config.action | default('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞') }}
                  parse_mode: markdown

mode: single