blueprint:
  name: Critical Value Monitor (single entity)
  description: >
    –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Å —É–¥–µ—Ä–∂–∞–Ω–∏–µ–º –¥–ª—è –æ–¥–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç–∏. 
    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º hold_seconds.
  domain: automation
  input:
    entity:
      name: Entity to monitor
      description: –°–µ–Ω—Å–æ—Ä –∏–ª–∏ –±–∏–Ω–∞—Ä–Ω—ã–π —Å–µ–Ω—Å–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å
      selector:
        entity:
    name:
      name: Display Name
      description: –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –∏–º—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      default: ""
    unit:
      name: Unit
      description: –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è –¥–ª—è —Å–µ–Ω—Å–æ—Ä–∞
      default: ""
    check_above:
      name: Check Above
      description: –ü–æ—Ä–æ–≥, –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –∫–æ—Ç–æ—Ä–æ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç alert
      default: null
      selector:
        number:
          min: -1000
          max: 1000
          step: 0.1
    check_below:
      name: Check Below
      description: –ü–æ—Ä–æ–≥, –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –Ω–∏–∂–µ –∫–æ—Ç–æ—Ä–æ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç alert
      default: null
      selector:
        number:
          min: -1000
          max: 1000
          step: 0.1
    check_state:
      name: Check State
      description: –ï—Å–ª–∏ —Å–µ–Ω—Å–æ—Ä ‚Äî –Ω–µ—á–∏—Å–ª–æ–≤–æ–π, —Å—Ä–∞–±–æ—Ç–∞–µ—Ç alert –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏
      default: ""
    check_states:
      name: Check States
      description: –°–ø–∏—Å–æ–∫ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π (–Ω–µ—á–∏—Å–ª–æ–≤–æ–π —Å–µ–Ω—Å–æ—Ä)
      default: []
      selector:
        object:
          multiple: true
    hold_seconds:
      name: Hold Seconds
      description: –í—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º
      default: 60
      selector:
        number:
          min: 0
          max: 3600
          step: 1
    delay_seconds:
      name: Delay before initial check
      description: –ü–∞—É–∑–∞ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –±—ã—Å—Ç—Ä—ã—Ö –∫–æ–ª–µ–±–∞–Ω–∏–π
      default: 5
      selector:
        number:
          min: 0
          max: 60
          step: 1

trigger:
  - platform: state
    entity_id: !input entity

variables:
  state_now: "{{ states(trigger.entity_id) }}"
  entity_name: "{{ input_name | default(states(trigger.entity_id).name) }}"
  unit: "{{ unit | default('') }}"
  hold_seconds: !input hold_seconds
  delay_seconds: !input delay_seconds

action:
  - delay:
      seconds: "{{ delay_seconds }}"

  - variables:
      num_value: "{{ state_now | float(default=None) }}"
      is_numeric: "{{ num_value is not none }}"
      alert: false
      reason: ""
      threshold: 0

  - choose:
      - conditions:
          - condition: template
            value_template: >
              {% if is_numeric %}
                {% if check_above is not none and num_value > check_above %}
                  true
                {% elif check_below is not none and num_value < check_below %}
                  true
                {% else %}
                  false
                {% endif %}
              {% else %}
                {% if check_state != "" and state_now == check_state %}
                  true
                {% elif check_states | length > 0 and state_now in check_states %}
                  true
                {% else %}
                  false
                {% endif %}
              {% endif %}
        sequence:
          - delay:
              seconds: "{{ hold_seconds }}"
          
          - variables:
              state_after: "{{ states(trigger.entity_id) }}"
              num_after: "{{ state_after | float(default=None) }}"
              is_numeric_after: "{{ num_after is not none }}"
              alert_after: false
              reason_after: ""
              threshold_after: 0

          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {% if is_numeric_after %}
                        {% if check_above is not none and num_after > check_above %}
                          true
                        {% elif check_below is not none and num_after < check_below %}
                          true
                        {% else %}
                          false
                        {% endif %}
                      {% else %}
                        {% if check_state != "" and state_after == check_state %}
                          true
                        {% elif check_states | length > 0 and state_after in check_states %}
                          true
                        {% else %}
                          false
                        {% endif %}
                      {% endif %}
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ is_numeric_after and check_above is not none and num_after > check_above }}"
                        sequence:
                          - service: notify.send_message
                            data:
                              message: >
                                üö° *–ü–†–ï–í–´–®–ï–ù–ò–ï - {{ entity_name }}*
                                üìä –¢–µ–∫—É—â–µ–µ: {{ state_after }}{{ unit }}
                                üìà –ü–æ—Ä–æ–≥: {{ check_above }}{{ unit }}
                                ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
                      - conditions:
                          - condition: template
                            value_template: "{{ is_numeric_after and check_below is not none and num_after < check_below }}"
                        sequence:
                          - service: notify.send_message
                            data:
                              message: >
                                üö° *–ù–ò–ñ–ï –ù–û–†–ú–´ - {{ entity_name }}*
                                üìä –¢–µ–∫—É—â–µ–µ: {{ state_after }}{{ unit }}
                                üìâ –ü–æ—Ä–æ–≥: {{ check_below }}{{ unit }}
                                ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
                      - conditions:
                          - condition: template
                            value_template: "{{ not is_numeric_after and (state_after == check_state or state_after in check_states) }}"
                        sequence:
                          - service: notify.send_message
                            data:
                              message: >
                                üö° *–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –°–û–°–¢–û–Ø–ù–ò–ï - {{ entity_name }}*
                                üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ: {{ state_after }}
                                ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è

mode: single
