blueprint:
  name: Critical Value Monitor (single entity) with Recommendation
  description: >
    ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğ¹ Ñ ÑƒĞ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ´Ğ»Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ÑÑƒÑ‰Ğ½Ğ¾ÑÑ‚Ğ¸. 
    Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´ÑÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼ hold_seconds.
  domain: automation
  input:
    entity:
      name: Entity to monitor
      description: Ğ¡ĞµĞ½ÑĞ¾Ñ€ Ğ¸Ğ»Ğ¸ Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğ¹ ÑĞµĞ½ÑĞ¾Ñ€, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ
      selector:
        entity:
    name:
      name: Display Name
      description: Ğ§ĞµĞ»Ğ¾Ğ²ĞµĞºĞ¾Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼Ğ¾Ğµ Ğ¸Ğ¼Ñ Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
      default: ""
    unit:
      name: Unit
      description: Ğ•Ğ´Ğ¸Ğ½Ğ¸Ñ†Ğ° Ğ¸Ğ·Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ ÑĞµĞ½ÑĞ¾Ñ€Ğ°
      default: ""
    check_above:
      name: Check Above
      description: ĞŸĞ¾Ñ€Ğ¾Ğ³, Ğ¿Ñ€Ğ¸ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½Ğ¸Ğ¸ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ alert
      default: null
      selector:
        number:
          min: -1000
          max: 1000
          step: 0.1
    check_below:
      name: Check Below
      description: ĞŸĞ¾Ñ€Ğ¾Ğ³, Ğ¿Ñ€Ğ¸ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğ¸ Ğ½Ğ¸Ğ¶Ğµ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ³Ğ¾ ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ alert
      default: null
      selector:
        number:
          min: -1000
          max: 1000
          step: 0.1
    check_state:
      name: Check State
      description: Ğ•ÑĞ»Ğ¸ ÑĞµĞ½ÑĞ¾Ñ€ â€” Ğ½ĞµÑ‡Ğ¸ÑĞ»Ğ¾Ğ²Ğ¾Ğ¹, ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ alert Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğ¸
      default: ""
    check_states:
      name: Check States
      description: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ½ĞµÑ‡Ğ¸ÑĞ»Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞµĞ½ÑĞ¾Ñ€Ğ°
      default: []
      selector:
        object:
          multiple: true
    hold_seconds:
      name: Hold Seconds
      description: Ğ’Ñ€ĞµĞ¼Ñ ÑƒĞ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¿ĞµÑ€ĞµĞ´ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸ĞµĞ¼
      default: 60
      selector:
        number:
          min: 0
          max: 3600
          step: 1
    delay_seconds:
      name: Delay before initial check
      description: ĞŸĞ°ÑƒĞ·Ğ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… ĞºĞ¾Ğ»ĞµĞ±Ğ°Ğ½Ğ¸Ğ¹
      default: 5
      selector:
        number:
          min: 0
          max: 60
          step: 1
    action:
      name: Recommendation / Action
      description: Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸ĞµĞ¹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ²ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ² ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
      default: "Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°"
      selector:
        text: {}

trigger:
  - platform: state
    entity_id: !input entity

variables:
  entity_name: "{{ name | default(states(trigger.entity_id).name) }}"
  state_now: "{{ states(trigger.entity_id) }}"
  unit: "{{ unit | default('') }}"
  hold_seconds: !input hold_seconds
  delay_seconds: !input delay_seconds
  recommendation: !input action

action:
  - delay:
      seconds: "{{ delay_seconds }}"

  - variables:
      num_value: "{{ state_now | float(default=None) }}"
      is_numeric: "{{ num_value is not none }}"
      alert: false
      reason: ""
      threshold: 0

  - choose:
      - conditions:
          - condition: template
            value_template: >
              {% if is_numeric %}
                {% if check_above is not none and num_value > check_above %}
                  true
                {% elif check_below is not none and num_value < check_below %}
                  true
                {% else %}
                  false
                {% endif %}
              {% else %}
                {% if check_state != "" and state_now == check_state %}
                  true
                {% elif check_states | length > 0 and state_now in check_states %}
                  true
                {% else %}
                  false
                {% endif %}
              {% endif %}
        sequence:
          - delay:
              seconds: "{{ hold_seconds }}"
          
          - variables:
              state_after: "{{ states(trigger.entity_id) }}"
              num_after: "{{ state_after | float(default=None) }}"
              is_numeric_after: "{{ num_after is not none }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ is_numeric_after and check_above is not none and num_after > check_above }}"
                sequence:
                  - service: notify.send_message
                    data:
                      message: >
                        ğŸš¡ *ĞŸĞ Ğ•Ğ’Ğ«Ğ¨Ğ•ĞĞ˜Ğ• - {{ entity_name }}*
                        ğŸ“Š Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ: {{ state_after }}{{ unit }}
                        ğŸ“ˆ ĞŸĞ¾Ñ€Ğ¾Ğ³: {{ check_above }}{{ unit }}
                        âš ï¸ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹
                        ğŸ’¡ {{ recommendation }}
              - conditions:
                  - condition: template
                    value_template: "{{ is_numeric_after and check_below is not none and num_after < check_below }}"
                sequence:
                  - service: notify.send_message
                    data:
                      message: >
                        ğŸš¡ *ĞĞ˜Ğ–Ğ• ĞĞĞ ĞœĞ« - {{ entity_name }}*
                        ğŸ“Š Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ: {{ state_after }}{{ unit }}
                        ğŸ“‰ ĞŸĞ¾Ñ€Ğ¾Ğ³: {{ check_below }}{{ unit }}
                        âš ï¸ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹
                        ğŸ’¡ {{ recommendation }}
              - conditions:
                  - condition: template
                    value_template: "{{ not is_numeric_after and (state_after == check_state or state_after in check_states) }}"
                sequence:
                  - service: notify.send_message
                    data:
                      message: >
                        ğŸš¡ *ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ• Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ• - {{ entity_name }}*
                        ğŸ“Š Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ: {{ state_after }}
                        âš ï¸ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ
                        ğŸ’¡ {{ recommendation }}

mode: single
