blueprint:
  name: Universal Critical Values Monitor (hold per entity)
  description: >
    –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Å —É–¥–µ—Ä–∂–∞–Ω–∏–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–Ω—Å–æ—Ä–∞. 
    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º hold_seconds.
  domain: automation

  input:
    entities_config:
      name: Entities Configuration
      description: >
        –ü—Ä–∏–º–µ—Ä:
        - entity_id: sensor.temp
          name: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
          unit: ¬∞C
          check_above: 28
          check_below: 18
          hold_seconds: 60
          action: –í–∫–ª—é—á–∏—Ç—å –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä
      selector:
        object:

    delay_seconds:
      name: Delay before initial check (sec)
      description: –ö–æ—Ä–æ—Ç–∫–∞—è –ø–∞—É–∑–∞ –ø–æ—Å–ª–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞, —á—Ç–æ–±—ã –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –±—ã—Å—Ç—Ä—ã–µ –∫–æ–ª–µ–±–∞–Ω–∏—è
      default: 5
      selector:
        number:
          min: 0
          max: 60
          unit_of_measurement: sec

trigger:
  - platform: state

variables:
  entities_config: !input entities_config
  delay_seconds: !input delay_seconds

condition:
  - condition: template
    value_template: "{{ trigger.entity_id in (entities_config | map(attribute='entity_id') | list) }}"

action:

  # –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ—Å–ª–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞
  - delay:
      seconds: "{{ delay_seconds }}"

  # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ entity
  - variables:
      entity_id: "{{ trigger.entity_id }}"
      state_now: "{{ states(entity_id) }}"
      entity_config: >
        {% set cfg = None %}
        {% for item in entities_config %}
          {% if item.entity_id == entity_id %}
            {% set cfg = item %}
          {% endif %}
        {% endfor %}
        {{ cfg }}

      hold_seconds: "{{ entity_config.hold_seconds | default(30) }}"

      # –ü–µ—Ä–≤–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏
      check_result: >
        {% set c = entity_config %}
        {% if c is none %}
          {{ {'alert': false} }}
        {% else %}
          {% set value = state_now %}
          {% set num_value = value | float(default=none) %}
          {% set is_numeric = num_value is not none %}
          {% set alert = false %}
          {% set reason = '' %}
          {% set threshold = 0 %}

          {% if is_numeric %}
            {% if c.check_above is defined and num_value > c.check_above %}
              {% set alert = true %}{% set reason = 'above' %}{% set threshold = c.check_above %}
            {% elif c.check_below is defined and num_value < c.check_below %}
              {% set alert = true %}{% set reason = 'below' %}{% set threshold = c.check_below %}
            {% endif %}
          {% else %}
            {% if c.check_state is defined and value == c.check_state %}
              {% set alert = true %}{% set reason = 'state_match' %}
            {% elif c.check_states is defined and value in c.check_states %}
              {% set alert = true %}{% set reason = 'state_in_list' %}
            {% endif %}
          {% endif %}
          {{ {'alert': alert, 'reason': reason, 'threshold': threshold} }}
        {% endif %}

  # –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ, –∂–¥—ë–º hold_seconds –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ check_result.alert }}"
        sequence:
          - delay:
              seconds: "{{ hold_seconds }}"

          - variables:
              state_now: "{{ states(entity_id) }}"
              check_result_after: >
                {% set c = entity_config %}
                {% set value = state_now %}
                {% set num_value = value | float(default=none) %}
                {% set is_numeric = num_value is not none %}
                {% set alert = false %}
                {% set reason = '' %}
                {% set threshold = 0 %}
                {% if is_numeric %}
                  {% if c.check_above is defined and num_value > c.check_above %}
                    {% set alert = true %}{% set reason = 'above' %}{% set threshold = c.check_above %}
                  {% elif c.check_below is defined and num_value < c.check_below %}
                    {% set alert = true %}{% set reason = 'below' %}{% set threshold = c.check_below %}
                  {% endif %}
                {% else %}
                  {% if c.check_state is defined and value == c.check_state %}
                    {% set alert = true %}{% set reason = 'state_match' %}
                  {% elif c.check_states is defined and value in c.check_states %}
                    {% set alert = true %}{% set reason = 'state_in_list' %}
                  {% endif %}
                {% endif %}
                {{ {'alert': alert, 'reason': reason, 'threshold': threshold} }}

          # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –ø–æ—Å–ª–µ hold_seconds —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å—ë –µ—â—ë –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ
          - condition: template
            value_template: "{{ check_result_after.alert }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ check_result_after.reason == 'above' }}"
                sequence:
                  - action: notify.send_message
                    target:
                      entity_id: notify.alarm
                    data:
                      message: >
                        üö® *–ü–†–ï–í–´–®–ï–ù–ò–ï - {{ entity_config.name | default(entity_id) }}*
                        üìä {{ state_now }}{{ entity_config.unit | default('') }}
                        üìà –ü–æ—Ä–æ–≥: {{ check_result_after.threshold }}{{ entity_config.unit | default('') }}
                        ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
                        üí° {{ entity_config.action | default('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ') }}

              - conditions:
                  - condition: template
                    value_template: "{{ check_result_after.reason == 'below' }}"
                sequence:
                  - action: notify.send_message
                    target:
                      entity_id: notify.alarm
                    data:
                      message: >
                        üö® *–ù–ò–ñ–ï –ù–û–†–ú–´ - {{ entity_config.name | default(entity_id) }}*
                        üìä {{ state_now }}{{ entity_config.unit | default('') }}
                        üìâ –ü–æ—Ä–æ–≥: {{ check_result_after.threshold }}{{ entity_config.unit | default('') }}
                        ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
                        üí° {{ entity_config.action | default('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ') }}

              - conditions:
                  - condition: template
                    value_template: "{{ check_result_after.reason in ['state_match','state_in_list'] }}"
                sequence:
                  - action: notify.send_message
                    target:
                      entity_id: notify.alarm
                    data:
                      message: >
                        üö® *–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –°–û–°–¢–û–Ø–ù–ò–ï - {{ entity_config.name | default(entity_id) }}*
                        üìä {{ state_now }}
                        ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è
                        üí° {{ entity_config.action | default('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞') }}

mode: single
