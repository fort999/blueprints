blueprint:
  name: Universal Critical Values Monitor (hold per entity)
  description: '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Å —É–¥–µ—Ä–∂–∞–Ω–∏–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–Ω—Å–æ—Ä–∞. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º hold_seconds.'
  domain: automation
  input:
    entities_config:
      name: Entities Configuration
      description: |
        –ü—Ä–∏–º–µ—Ä:
        - entity_id: sensor.temp
          name: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
          unit: "¬∞C"
          check_above: 28
          check_below: 18
          hold_seconds: 60
          action: –í–∫–ª—é—á–∏—Ç—å –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä
      selector:
        object:
          multiple: true
    delay_seconds:
      name: Delay before initial check (sec)
      description: –ö–æ—Ä–æ—Ç–∫–∞—è –ø–∞—É–∑–∞ –ø–æ—Å–ª–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞, —á—Ç–æ–±—ã –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –±—ã—Å—Ç—Ä—ã–µ –∫–æ–ª–µ–±–∞–Ω–∏—è
      default: 5
      selector:
        number:
          min: 0.0
          max: 60.0
          unit_of_measurement: sec
          step: 1.0
          mode: slider

trigger:
  - platform: state
    entity_id: >
      {% set entities = [] %}
      {% for item in inputs.entities_config %}
        {% set _ = entities.append(item.entity_id) %}
      {% endfor %}
      {{ entities }}

variables:
  entities_config: !input 'entities_config'
  delay_seconds: !input 'delay_seconds'
  entity_id: "{{ trigger.entity_id }}"
  state_now: "{{ states(trigger.entity_id) }}"

action:
  - delay:
      seconds: "{{ delay_seconds }}"
  
  - variables:
      entity_config: >
        {% for item in entities_config %}
          {% if item.entity_id == entity_id %}
            {{ item }}
          {% endif %}
        {% endfor %}
      hold_seconds: "{{ entity_config.hold_seconds | default(30) }}"
      check_result: >
        {% if entity_config is not defined or entity_config is none %}
          {{ {'alert': false} }}
        {% else %}
          {% set value = state_now %}
          {% set num_value = value | float(default=none) %}
          {% set is_numeric = num_value is not none %}
          
          {% set alert = false %}
          {% set reason = '' %}
          {% set threshold = 0 %}
          
          {% if is_numeric %}
            {% if entity_config.check_above is defined and num_value > entity_config.check_above %}
              {% set alert = true %}
              {% set reason = 'above' %}
              {% set threshold = entity_config.check_above %}
            {% elif entity_config.check_below is defined and num_value < entity_config.check_below %}
              {% set alert = true %}
              {% set reason = 'below' %}
              {% set threshold = entity_config.check_below %}
            {% endif %}
          {% else %}
            {% if entity_config.check_state is defined and value == entity_config.check_state %}
              {% set alert = true %}
              {% set reason = 'state_match' %}
            {% elif entity_config.check_states is defined and value in entity_config.check_states %}
              {% set alert = true %}
              {% set reason = 'state_in_list' %}
            {% endif %}
          {% endif %}
          
          {{ {'alert': alert, 'reason': reason, 'threshold': threshold} }}
        {% endif %}

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ check_result.alert }}"
        sequence:
          - delay:
              seconds: "{{ hold_seconds }}"
          
          - variables:
              state_now: "{{ states(entity_id) }}"
              check_result_after: >
                {% set value = state_now %}
                {% set num_value = value | float(default=none) %}
                {% set is_numeric = num_value is not none %}
                
                {% set alert = false %}
                {% set reason = '' %}
                {% set threshold = 0 %}
                
                {% if is_numeric %}
                  {% if entity_config.check_above is defined and num_value > entity_config.check_above %}
                    {% set alert = true %}
                    {% set reason = 'above' %}
                    {% set threshold = entity_config.check_above %}
                  {% elif entity_config.check_below is defined and num_value < entity_config.check_below %}
                    {% set alert = true %}
                    {% set reason = 'below' %}
                    {% set threshold = entity_config.check_below %}
                  {% endif %}
                {% else %}
                  {% if entity_config.check_state is defined and value == entity_config.check_state %}
                    {% set alert = true %}
                    {% set reason = 'state_match' %}
                  {% elif entity_config.check_states is defined and value in entity_config.check_states %}
                    {% set alert = true %}
                    {% set reason = 'state_in_list' %}
                  {% endif %}
                {% endif %}
                
                {{ {'alert': alert, 'reason': reason, 'threshold': threshold} }}
          
          - condition: template
            value_template: "{{ check_result_after.alert }}"
          
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ check_result_after.reason == 'above' }}"
                sequence:
                  - service: notify.send_message
                    data:
                      message: >
                        üö° *–ü–†–ï–í–´–®–ï–ù–ò–ï - {{ entity_config.name | default(entity_id) }}*
                        
                        üìä –¢–µ–∫—É—â–µ–µ: {{ state_now }}{{ entity_config.unit | default('') }}
                        üìà –ü–æ—Ä–æ–≥: {{ check_result_after.threshold }}{{ entity_config.unit | default('') }}
                        ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
                        
                        üí° {{ entity_config.action | default('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ') }}
              - conditions:
                  - condition: template
                    value_template: "{{ check_result_after.reason == 'below' }}"
                sequence:
                  - service: notify.send_message
                    data:
                      message: >
                        üö° *–ù–ò–ñ–ï –ù–û–†–ú–´ - {{ entity_config.name | default(entity_id) }}*
                        
                        üìä –¢–µ–∫—É—â–µ–µ: {{ state_now }}{{ entity_config.unit | default('') }}
                        üìâ –ü–æ—Ä–æ–≥: {{ check_result_after.threshold }}{{ entity_config.unit | default('') }}
                        ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
                        
                        üí° {{ entity_config.action | default('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ') }}
              - conditions:
                  - condition: template
                    value_template: "{{ check_result_after.reason in ['state_match', 'state_in_list'] }}"
                sequence:
                  - service: notify.send_message
                    data:
                      message: >
                        üö° *–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –°–û–°–¢–û–Ø–ù–ò–ï - {{ entity_config.name | default(entity_id) }}*
                        
                        üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ: {{ state_now }}
                        ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å: –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è
                        
                        üí° {{ entity_config.action | default('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞') }}

mode: single
