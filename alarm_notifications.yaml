blueprint:
  name: Critical Value Monitor (single entity, universal)
  description: >
    ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð¾Ð´Ð½Ð¾Ð¹ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚Ð¸. ÐŸÐ¾Ð´Ñ…Ð¾Ð´Ð¸Ñ‚ Ð´Ð»Ñ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ñ‹Ñ…
    Ð¸ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ñ…/ÑÑ‚Ñ€Ð¾ÐºÐ¾Ð²Ñ‹Ñ… ÑÐµÐ½ÑÐ¾Ñ€Ð¾Ð². Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´ÑÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¾ÑÑ‚Ð°Ñ‘Ñ‚ÑÑ
    ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ hold_seconds.
  domain: automation
  input:
    entity:
      name: Entity to monitor
      description: Ð¡ÐµÐ½ÑÐ¾Ñ€ Ð¸Ð»Ð¸ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ð¹ ÑÐµÐ½ÑÐ¾Ñ€ Ð´Ð»Ñ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
      selector:
        entity:
          reorder: false
          multiple: false
    name:
      name: Display Name
      description: Ð§ÐµÐ»Ð¾Ð²ÐµÐºÐ¾Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ð¾Ðµ Ð¸Ð¼Ñ Ð´Ð»Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹
      default: ''
    unit:
      name: Unit
      description: Ð•Ð´Ð¸Ð½Ð¸Ñ†Ð° Ð¸Ð·Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ (Ð´Ð»Ñ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ñ‹Ñ… ÑÐµÐ½ÑÐ¾Ñ€Ð¾Ð²)
      default: ''
    check_above:
      name: Check Above
      description: ÐŸÐ¾Ñ€Ð¾Ð³, Ð¿Ñ€Ð¸ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¸Ð¸ ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ ÑÑ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ alert
      default:
      selector:
        number:
          min: -1000.0
          max: 1000.0
          step: 0.1
          mode: slider
    check_below:
      name: Check Below
      description: ÐŸÐ¾Ñ€Ð¾Ð³, Ð¿Ñ€Ð¸ Ð¿Ð°Ð´ÐµÐ½Ð¸Ð¸ Ð½Ð¸Ð¶Ðµ ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ ÑÑ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ alert
      default:
      selector:
        number:
          min: -1000.0
          max: 1000.0
          step: 0.1
          mode: slider
    check_state:
      name: Check State
      description: Ð•ÑÐ»Ð¸ ÑÐµÐ½ÑÐ¾Ñ€ Ð½Ðµ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ð¾Ð¹, ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ alert Ð¿Ñ€Ð¸ ÑÐ¾Ð²Ð¿Ð°Ð´ÐµÐ½Ð¸Ð¸
      default: ''
    check_states:
      name: Check States
      description: Ð¡Ð¿Ð¸ÑÐ¾Ðº ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð½ÐµÑ‡Ð¸ÑÐ»Ð¾Ð²Ð¾Ð³Ð¾ ÑÐµÐ½ÑÐ¾Ñ€Ð°
      default: []
      selector:
        object:
          multiple: true
    hold_seconds:
      name: Hold Seconds
      description: Ð’Ñ€ÐµÐ¼Ñ ÑƒÐ´ÐµÑ€Ð¶Ð°Ð½Ð¸Ñ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ´ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸ÐµÐ¼
      default: 60
      selector:
        number:
          min: 0.0
          max: 3600.0
          step: 1.0
          mode: slider
    action:
      name: Recommendation / Action
      description: Ð¢ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸ÐµÐ¹, Ð²ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ÑÑ Ð² ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ
      default: Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
      selector:
        text:
          multiple: false
          multiline: false
    notify_target:
      name: Notification Target
      description: Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ, ÐºÑƒÐ´Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
      selector:
        entity:
          domain:
          - notify
          reorder: false
          multiple: false
  source_url: https://github.com/fort999/blueprints/blob/main/alarm_notifications.yaml

trigger:
  - platform: state
    entity_id: !input entity

variables:
  entity_name: '{{ name | default(states(trigger.entity_id).name) }}'
  hold_seconds: !input hold_seconds
  recommendation: !input action
  unit: '{{ unit | default('''') }}'
  check_above_val: !input check_above
  check_below_val: !input check_below
  check_state_val: !input check_state
  check_states_val: !input check_states

action:
  - delay:
      seconds: '{{ hold_seconds }}'
  - variables:
      state_after: '{{ states(trigger.entity_id) }}'
      num_after: '{{ state_after | float(default=None) }}'
      is_numeric: '{{ num_after is not none }}'
  - choose:
      - conditions:
          - condition: template
            value_template: >-
              {% if is_numeric %}
                {{ (check_above_val is not none and num_after > check_above_val) or
                   (check_below_val is not none and num_after < check_below_val) }}
              {% else %}
                {{ (check_state_val != "" and state_after == check_state_val) or
                   (check_states_val | length > 0 and state_after in check_states_val) }}
              {% endif %}
        sequence:
          - service: notify.send_message
            target:
              entity_id: !input notify_target
            data:
              message: >-
                ðŸš¡ *ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐžÐ• Ð¡ÐžÐ¡Ð¢ÐžÐ¯ÐÐ˜Ð• - {{ entity_name }}*
                ðŸ“Š Ð¢ÐµÐºÑƒÑ‰ÐµÐµ: {{ state_after }}{{ unit }}
                {% if is_numeric and check_above_val is not none and num_after > check_above_val %}
                ðŸ“ˆ ÐŸÐ¾Ñ€Ð¾Ð³: {{ check_above_val }}{{ unit }}
                {% elif is_numeric and check_below_val is not none and num_after < check_below_val %}
                ðŸ“‰ ÐŸÐ¾Ñ€Ð¾Ð³: {{ check_below_val }}{{ unit }}
                {% endif %}
                âš ï¸ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹
                ðŸ’¡ {{ recommendation }}
mode: single
